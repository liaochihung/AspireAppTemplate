@using AspireAppTemplate.Web.Infrastructure.Services
@inherits LayoutComponentBase
@implements IDisposable
@layout BaseLayout
@inject LayoutService LayoutService

<MudAppBar Color="Color.Surface" Elevation="0">
    <MudTooltip Text="Toggle Drawer">
        <MudIconButton Icon="@Icons.Material.Rounded.Notes" Color="Color.Inherit" Edge="Edge.Start"
            OnClick="@DrawerToggle" />
    </MudTooltip>
    <MudButton Variant="Variant.Text" Color="Color.Transparent" Href="/" DropShadow="false">
        首頁
    </MudButton>
    <MudSpacer />
    
    <MudTooltip Text="@(LayoutService.IsDarkMode ? "淺色模式" : "深色模式")">
        <MudIconButton Icon="@(LayoutService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       Color="Color.Inherit" OnClick="@ToggleDarkMode" />
    </MudTooltip>
    
    <MudTooltip Text="主題設定">
        <MudIconButton Icon="@Icons.Material.Filled.Palette" Color="Color.Inherit" 
                       OnClick="@(() => _themeDrawerOpen = true)" />
    </MudTooltip>

    <LoginDisplay />
</MudAppBar>

<MudDrawer @bind-Open="_drawerOpen" Variant="DrawerVariant.Mini" Outlined ClipMode="DrawerClipMode.Never">
    <NavMenu IsOpen="_drawerOpen" />
</MudDrawer>

<ThemeDrawer @bind-Open="_themeDrawerOpen" />

<MudMainContent>
    <MudContainer MaxWidth="MaxWidth.False" Class="px-6 py-6">
        @Body
    </MudContainer>
</MudMainContent>

@code {
    private bool _drawerOpen;
    private bool _isDarkMode;
    private bool _themeDrawerOpen;

    protected override async Task OnInitializedAsync()
    {
        var prefs = await LayoutService.GetPreferenceAsync();
        _drawerOpen = prefs.IsDrawerOpen;
        _isDarkMode = prefs.IsDarkMode;
        
        LayoutService.MajorUpdateOccurred += OnMajorUpdateOccurred;
    }

    private async Task DrawerToggle()
    {
        _drawerOpen = await LayoutService.ToggleDrawerAsync();
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        await LayoutService.SetDarkModeAsync(_isDarkMode);
    }

    private void OnMajorUpdateOccurred(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        LayoutService.MajorUpdateOccurred -= OnMajorUpdateOccurred;
    }
}

@using AspireAppTemplate.Web.Infrastructure.Themes
@using AspireAppTemplate.Web.Infrastructure.Services
@implements IDisposable
@inherits LayoutComponentBase
@inject LayoutService LayoutService

<MudThemeProvider @ref="_mudThemeProvider" Theme="_theme" @bind-IsDarkMode="LayoutService.IsDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    @Body
</MudLayout>

@code {
    private MudThemeProvider? _mudThemeProvider;
    private AppTheme _theme = new();

    protected override void OnInitialized()
    {
        LayoutService.MajorUpdateOccurred += LayoutServiceOnMajorUpdateOccurred;
    }

    private async void LayoutServiceOnMajorUpdateOccurred(object? sender, EventArgs e)
    {
        var prefs = await LayoutService.GetPreferenceAsync();
        LayoutService.ApplyUserPreferences(_theme, prefs);
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        LayoutService.MajorUpdateOccurred -= LayoutServiceOnMajorUpdateOccurred;
    }
}

@page "/products"
@using System.Linq
@using Microsoft.AspNetCore.Components.Authorization
@using AspireAppTemplate.Shared
@rendermode InteractiveServer
@inject ProductApiClient ProductApiClient
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject PersistentComponentState ApplicationState
@implements IDisposable

<MudText Typo="Typo.h4" GutterBottom="true">Products</MudText>

<AuthorizeView>
    <Authorized>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
        }
        @if (isLoading)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            <MudGrid>
                <MudItem xs="12" lg="7">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudText Typo="Typo.h6" GutterBottom="true">Product List</MudText>
                        <MudTable Items="@products" Hover="true" Dense="true" Striped="true" Context="product">
                            <HeaderContent>
                                <MudTh>Name</MudTh>
                                <MudTh Style="text-align: right">Price</MudTh>
                                <MudTh>Description</MudTh>
                                <AuthorizeView Policy="@AppPolicies.CanManageProducts" Context="authContext">
                                    <Authorized>
                                        <MudTh Style="text-align: right">Actions</MudTh>
                                    </Authorized>
                                </AuthorizeView>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Name">@product.Name</MudTd>
                                <MudTd DataLabel="Price" Style="text-align: right">@product.Price.ToString("C")</MudTd>
                                <MudTd DataLabel="Description">@product.Description</MudTd>
                                <AuthorizeView Policy="@AppPolicies.CanManageProducts" Context="authContext2">
                                    <Authorized>
                                        <MudTd DataLabel="Actions" Style="text-align: right">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => StartEdit(product))" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => ConfirmDelete(product.Id))" />
                                        </MudTd>
                                    </Authorized>
                                </AuthorizeView>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No products found.</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    </MudPaper>
                </MudItem>

                <AuthorizeView Policy="@AppPolicies.CanManageProducts" Context="authContext">
                    <Authorized>
                        <MudItem xs="12" lg="5">
                            <MudPaper Class="pa-4" Elevation="1">
                                <MudText Typo="Typo.h6" GutterBottom="true">@((isEditing) ? "Edit Product" : "Add Product")</MudText>

                                <MudTextField @bind-Value="formModel.Name" Label="Name" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" />
                                <MudNumericField @bind-Value="formModel.Price" Label="Price" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" Format="N2" />
                                <MudTextField @bind-Value="formModel.Description" Label="Description" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" />

                                <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                                    @if (isEditing)
                                    {
                                        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="CancelEdit">Cancel</MudButton>
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveForm">Save Changes</MudButton>
                                    }
                                    else
                                    {
                                        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ClearForm">Clear</MudButton>
                                        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="SaveForm">Add Product</MudButton>
                                    }
                                </MudStack>
                            </MudPaper>

                            <MudText Typo="Typo.caption" Class="mt-2 mud-text-secondary">
                                Tip: Click edit to load a product into the form.
                            </MudText>
                        </MudItem>
                    </Authorized>
                </AuthorizeView>
            </MudGrid>
        }

    </Authorized>
    <NotAuthorized>
        <MudAlert Severity="Severity.Info">
            Please <MudLink Href="authentication/login">log in</MudLink> to view the product data.
        </MudAlert>
    </NotAuthorized>
</AuthorizeView>



@page "/products"
@using System.Linq
@using Microsoft.AspNetCore.Components.Authorization
@using AspireAppTemplate.Shared
@rendermode InteractiveServer
@inject ProductApiClient ProductApiClient
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject PersistentComponentState ApplicationState
@implements IDisposable

<AuthorizeView Context="authContext">
    <Authorized>
        <PageHeader Icon="@Icons.Material.Filled.Inventory2"
                    Title="@Loc["Products_Title"]"
                    Description="@Loc["Products_Description"]">
            @if (_canManage)
            {
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="@(() => OpenAddForm())"
                           DropShadow="false">
                    @Loc["Product_CreateTitle"]
                </MudButton>
            }
        </PageHeader>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => errorMessage = null)">
                @errorMessage
            </MudAlert>
        }

        <MudGrid Spacing="4">
            <MudItem xs="12" lg="@(showForm ? 7 : 12)">
                <MudPaper Elevation="2" Class="pa-0">
                    @if (isLoading)
                    {
                        <div class="pa-6 d-flex justify-center">
                            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                        </div>
                    }
                    else
                    {
                        <AppDataGrid T="Product" Items="@products" Filterable="true" QuickFilter="@_quickFilter">
                            <ToolBarContent>
                                <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
                                    @Loc["TotalItems", products?.Length ?? 0]
                                </MudText>
                                <MudSpacer />
                                <DebouncedSearchField @bind-Value="_searchString"
                                                      Placeholder="@Loc["Search"]"
                                                      DebounceMs="300"
                                                      Style="max-width: 250px;" />
                            </ToolBarContent>
                            <Columns>
                                <TemplateColumn T="Product" Title="@Loc["Product_Name"]">
                                    <CellTemplate Context="cellContext">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Color="Color.Primary" />
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@cellContext.Item.Name</MudText>
                                        </MudStack>
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn T="Product" Title="@Loc["Product_Price"]">
                                    <CellTemplate Context="cellContext">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">
                                            @cellContext.Item.Price.ToString("C")
                                        </MudChip>
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn T="Product" Title="@Loc["Product_Description"]">
                                    <CellTemplate Context="cellContext">
                                        @if (!string.IsNullOrWhiteSpace(cellContext.Item.Description))
                                        {
                                            <MudText Typo="Typo.body2" Class="mud-text-secondary" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                @cellContext.Item.Description
                                            </MudText>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Class="mud-text-disabled">â€”</MudText>
                                        }
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn T="Product" Title="@Loc["Actions"]" Hidden="@(!_canManage)">
                                    <CellTemplate Context="cellContext">
                                        <MudTooltip Text="@Loc["Edit"]">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                           Size="Size.Small"
                                                           Color="Color.Primary"
                                                           OnClick="@(() => StartEdit(cellContext.Item))" />
                                        </MudTooltip>
                                        <MudTooltip Text="@Loc["Delete"]">
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="@(() => ConfirmDelete(cellContext.Item.Id))" />
                                        </MudTooltip>
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>
                            <PagerContent>
                                <MudDataGridPager T="Product" />
                            </PagerContent>
                            <NoRecordsContent>
                                <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" Color="Color.Default" />
                                    <MudText Typo="Typo.body1" Color="Color.Default">@Loc["NoRecords"]</MudText>
                                    @if (_canManage)
                                    {
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.Add"
                                                   OnClick="@(() => OpenAddForm())"
                                                   Class="mt-2">
                                            @Loc["CreateFirstRecord"]
                                        </MudButton>
                                    }
                                </MudStack>
                            </NoRecordsContent>
                        </AppDataGrid>
                    }
                </MudPaper>
            </MudItem>

            @if (showForm && _canManage)
            {
                <MudItem xs="12" lg="5">
                    <MudPaper Elevation="2" Class="pa-4">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@(isEditing ? Icons.Material.Filled.Edit : Icons.Material.Filled.Add)"
                                         Color="Color.Primary" />
                                <MudText Typo="Typo.h6">@(isEditing ? Loc["Product_EditTitle"] : Loc["Product_CreateTitle"])</MudText>
                            </MudStack>
                            <MudIconButton Icon="@Icons.Material.Filled.Close"
                                           Size="Size.Small"
                                           OnClick="CloseForm" />
                        </MudStack>

                        <MudDivider Class="mb-4" />
                        <MudTextField @bind-Value="formModel.Name"
                                      Label="@Loc["Product_Name"]"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mb-3"
                                      Required="true"
                                      RequiredError="@Loc["RequiredError", Loc["Product_Name"]]" />

                        <MudNumericField @bind-Value="formModel.Price"
                                         Label="@Loc["Product_Price"]"
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Class="mb-3"
                                         Format="N2"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.AttachMoney" />

                        <MudTextField @bind-Value="formModel.Description"
                                      Label="@Loc["Product_Description"]"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mb-4"
                                      Lines="3" />

                        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                            @if (isEditing)
                            {
                                <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="CancelEdit">@Loc["Cancel"]</MudButton>
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveForm" DropShadow="false">@Loc["Save"]</MudButton>
                            }
                            else
                            {
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ClearForm">@Loc["Clear"]</MudButton>
                                <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="SaveForm" DropShadow="false">@Loc["Product_CreateTitle"]</MudButton>
                            }
                        </MudStack>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </Authorized>
    <NotAuthorized>
        <MudAlert Severity="Severity.Info">
            @Loc["Auth_LoginRequired"] <MudLink Href="authentication/login">@Loc["Login"]</MudLink>
        </MudAlert>
    </NotAuthorized>
</AuthorizeView>

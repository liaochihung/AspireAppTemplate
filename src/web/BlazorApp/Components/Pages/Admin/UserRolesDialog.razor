@using AspireAppTemplate.Shared
@using AspireAppTemplate.Web
@using MudBlazor
@inject IdentityApiClient IdentityClient
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.Security" Class="mr-3" Color="Color.Primary" />
            <div>
                <MudText Typo="Typo.h6">分配角色</MudText>
                <MudText Typo="Typo.caption">管理使用者 <b>@User.Username</b> 的權限</MudText>
            </div>
        </div>
    </TitleContent>
    <DialogContent>
        <div style="min-height: 300px;">
            @if (_loading)
            {
                <div class="d-flex flex-column align-center justify-center py-12">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                    <MudText Typo="Typo.body2" Class="mt-4">載入權限中...</MudText>
                </div>
            }
            else
            {
                <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">新增權限</MudText>
                <div class="d-flex align-end gap-2 mb-6">
                    <MudSelect T="string" Label="選擇角色" 
                               @bind-Value="_selectedRole" 
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               AnchorOrigin="Origin.BottomCenter">
                        @foreach (var role in _availableRoles)
                        {
                            <MudSelectItem Value="@role.Name">@role.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               OnClick="AddRole" 
                               Disabled="@string.IsNullOrEmpty(_selectedRole)"
                               DisableElevation="true"
                               Style="height: 40px;"
                               StartIcon="@Icons.Material.Filled.Add">加入</MudButton>
                </div>

                <MudDivider Class="mb-4" />

                <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-3">已持有的角色 (@_assignedRoles.Count)</MudText>
                
                @if (!_assignedRoles.Any())
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mt-2">
                        此使用者目前沒有任何角色。
                    </MudAlert>
                }
                else
                {
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var role in _assignedRoles.Select(r => r.Name))
                        {
                            <MudChip T="string" 
                                     Text="@role" 
                                     OnClose="(() => RemoveRoleByName(role))" 
                                     Color="Color.Info" 
                                     Variant="Variant.Filled" />
                        }
                    </div>
                }
            }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Variant="Variant.Filled" Class="px-8" DisableElevation="true">關閉</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public KeycloakUser User { get; set; } = default!;

    private List<KeycloakRole> _assignedRoles = new();
    private List<KeycloakRole> _availableRoles = new();
    private string _selectedRole = string.Empty;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        _loading = true;
        try
        {
            if (string.IsNullOrEmpty(User.Id))
            {
                Snackbar.Add("User ID is missing", Severity.Error);
                return;
            }

            var assignedTask = IdentityClient.GetUserRolesAsync(User.Id);
            var availableTask = IdentityClient.GetRolesAsync();

            await Task.WhenAll(assignedTask, availableTask);

            _assignedRoles = (await assignedTask).ToList();
            _availableRoles = (await availableTask).Where(r => _assignedRoles.All(ar => ar.Name != r.Name)).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading roles: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task AddRole()
    {
        if (string.IsNullOrEmpty(_selectedRole)) return;
        if (string.IsNullOrEmpty(User.Id))
        {
            Snackbar.Add("User ID is missing", Severity.Error);
            return;
        }

        try
        {
            await IdentityClient.AssignRoleAsync(User.Id, _selectedRole);
            Snackbar.Add($"Role {_selectedRole} assigned", Severity.Success);
            _selectedRole = string.Empty;
            await LoadRoles();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error assigning role: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemoveRoleByName(string roleName)
    {
        if (string.IsNullOrEmpty(User.Id))
        {
            Snackbar.Add("User ID is missing", Severity.Error);
            return;
        }

        try
        {
            await IdentityClient.RemoveRoleAsync(User.Id, roleName);
            Snackbar.Add($"Role {roleName} removed", Severity.Success);
            await LoadRoles();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing role: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemoveRole(MudChip<string> chip)
    {
        var roleName = chip.Value;
        if (string.IsNullOrEmpty(roleName)) return;
        await RemoveRoleByName(roleName);
    }

    private void Close() => MudDialog.Close();
}

@page "/admin/roles"
@attribute [Authorize(Policy = AppPolicies.CanManageProducts)]
@using AspireAppTemplate.Web
@using AspireAppTemplate.Shared
@using Microsoft.AspNetCore.Authorization
@inject IdentityApiClient IdentityClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h5" GutterBottom="true">角色管理</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateRole" Class="mb-4">新增角色</MudButton>

<MudDataGrid Items="@_roles" Loading="@_loading" Filterable="true">
    <Columns>
        <PropertyColumn Property="x => x.Name" Title="名稱" />
        <PropertyColumn Property="x => x.Description" Title="描述" />
        <TemplateColumn CellClass="d-flex justify-end">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteRole(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>

@code {
    private IEnumerable<KeycloakRole> _roles = new List<KeycloakRole>();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        _loading = true;
        try {
            _roles = await IdentityClient.GetRolesAsync();
        } catch (Exception ex) {
            Snackbar.Add($"角色載入失敗: {ex.Message}", Severity.Error);
        } finally {
            _loading = false;
        }
    }

    private async Task CreateRole()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CreateRoleDialog>("Create Role", options);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled && result.Data is KeycloakRole role)
        {
            try {
                await IdentityClient.CreateRoleAsync(role);
                Snackbar.Add("角色已新增", Severity.Success);
                await LoadRoles();
            } catch (Exception ex) {
                Snackbar.Add($"角色新增失敗: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteRole(KeycloakRole role)
    {
         var result = await DialogService.ShowMessageBox(
            "刪除角色", 
            $"確定要刪除 {role.Name} 嗎?", 
            yesText: "刪除", cancelText: "取消");

        if (result == true)
        {
             try {
                await IdentityClient.DeleteRoleAsync(role.Name);
                Snackbar.Add("角色已刪除", Severity.Success);
                await LoadRoles();
            } catch (Exception ex) {
                Snackbar.Add($"角色刪除失敗: {ex.Message}", Severity.Error);
            }
        }
    }
}

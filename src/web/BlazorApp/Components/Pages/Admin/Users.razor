@page "/admin/users"
@inherits AspireAppTemplate.Web.Components.Pages.AuthenticatedComponentBase
@attribute [Authorize(Policy = AppPolicies.CanManageProducts)]
@using AspireAppTemplate.Web
@using AspireAppTemplate.Shared
@using Microsoft.AspNetCore.Authorization
@inject IdentityApiClient IdentityClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageHeader Icon="@Icons.Material.Filled.People" 
            Title="@Loc["Users_Title"]" 
            Description="@Loc["Users_Description"]">
    <MudButton Variant="Variant.Filled" 
               Color="Color.Primary" 
               StartIcon="@Icons.Material.Filled.PersonAdd" 
               OnClick="@(() => OpenUserDialog())"
               DropShadow="false">
        @Loc["User_Create"]
    </MudButton>
</PageHeader>

<MudPaper Elevation="2" Class="pa-0">
    <AppDataGrid T="KeycloakUser" Items="@_users" Loading="@_loading" Filterable="true" QuickFilter="@_quickFilter">
        <ToolBarContent>
            <MudSpacer />
            <MudSpacer />
            <DebouncedSearchField @bind-Value="_searchString" 
                                  Placeholder="@Loc["Search"]"
                                  DebounceMs="300" />
        </ToolBarContent>
        <Columns>
            <TemplateColumn T="KeycloakUser" Title="@Loc["User_Username"]">
                <CellTemplate Context="cellContext">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudAvatar Size="Size.Small" Color="Color.Primary">
                            @(cellContext.Item.Username?.FirstOrDefault().ToString().ToUpper() ?? "?")
                        </MudAvatar>
                        <MudText Typo="Typo.body2">@cellContext.Item.Username</MudText>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="KeycloakUser" Title="@Loc["User_Email"]">
                <CellTemplate Context="cellContext">
                    <MudText Typo="Typo.body2">@cellContext.Item.Email</MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="KeycloakUser" Title="@Loc["User_FirstName"]">
                <CellTemplate Context="cellContext">
                    <MudText Typo="Typo.body2">@cellContext.Item.FirstName</MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="KeycloakUser" Title="@Loc["User_LastName"]">
                <CellTemplate Context="cellContext">
                    <MudText Typo="Typo.body2">@cellContext.Item.LastName</MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="KeycloakUser" Title="@Loc["User_Status"]">
                <CellTemplate Context="cellContext">
                    @if (cellContext.Item.Enabled)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">@Loc["User_Enabled"]</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">@Loc["User_Disabled"]</MudChip>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="KeycloakUser" Title="@Loc["User_LastLogin"]">
                <CellTemplate Context="cellContext">
                   <MudText Typo="Typo.body2">
                       @(cellContext.Item.LastLoginAt.HasValue 
                           ? cellContext.Item.LastLoginAt.Value.ToLocalTime().ToString("yyyy/MM/dd HH:mm") 
                           : "-")
                   </MudText>
                </CellTemplate>
            </TemplateColumn>
                <TemplateColumn T="KeycloakUser" Title="@Loc["Actions"]">
                <CellTemplate Context="cellContext">
                    @{
                        var isCurrentUser = _currentUserId == cellContext.Item.Id;
                    }
                    <MudTooltip Text="@Loc["User_AssignRoles"]">
                        <MudIconButton Icon="@Icons.Material.Filled.Assignment" 
                                       Color="Color.Secondary" 
                                       Size="Size.Small"
                                       OnClick="@(() => ManageRoles(cellContext.Item))" />
                    </MudTooltip>
                    <MudTooltip Text="@Loc["User_Edit"]">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       OnClick="@(() => OpenUserDialog(cellContext.Item))" />
                    </MudTooltip>
                    <MudTooltip Text="@(isCurrentUser ? Loc["User_CannotDeleteSelf"] : Loc["User_Delete"])">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       Disabled="@isCurrentUser"
                                       OnClick="@(() => DeleteUser(cellContext.Item))" />
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="KeycloakUser" />
        </PagerContent>
        <NoRecordsContent>
            <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                <MudIcon Icon="@Icons.Material.Filled.PersonOff" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.body1" Color="Color.Default">@Loc["User_NoRecords"]</MudText>
            </MudStack>
        </NoRecordsContent>
    </AppDataGrid>
</MudPaper>

@page "/custom-jobs"
@inherits AspireAppTemplate.Web.Components.Pages.AuthenticatedComponentBase
@attribute [Authorize(Policy = AppPolicies.CanManageSystem)]
@using AspireAppTemplate.Web
@using AspireAppTemplate.Shared
@using Microsoft.AspNetCore.Authorization
@inject CustomJobsApiClient ApiClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageHeader Icon="@Icons.Material.Filled.Schedule" 
            Title="@Loc["CustomJobs_Title"]" 
            Description="@Loc["CustomJobs_Description"]">
    <MudButton Variant="Variant.Filled" 
               Color="Color.Primary" 
               StartIcon="@Icons.Material.Filled.Add" 
               OnClick="CreateJob"
               DropShadow="false">
        @Loc["Job_Create"]
    </MudButton>
</PageHeader>

<MudPaper Elevation="2" Class="pa-0">
    <AppDataGrid T="CustomJobsApiClient.JobDto" Items="@_jobs" Loading="@_loading" Filterable="true" QuickFilter="@_quickFilter">
        <ToolBarContent>
            <MudSpacer />
            <DebouncedSearchField @bind-Value="_searchString" 
                                  Placeholder="@Loc["Search"]"
                                  DebounceMs="300" />
        </ToolBarContent>
        <Columns>
            <TemplateColumn T="CustomJobsApiClient.JobDto" Title="@Loc["Job_Name"]">
                <CellTemplate Context="cellContext">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@cellContext.Item.Name</MudText>
                        @if (!string.IsNullOrEmpty(cellContext.Item.Description))
                        {
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">@cellContext.Item.Description</MudText>
                        }
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="CustomJobsApiClient.JobDto" Title="@Loc["Job_Type"]">
                <CellTemplate Context="cellContext">
                    <MudChip T="string" Size="Size.Small" Color="@(cellContext.Item.Type == 1 ? Color.Info : Color.Success)">
                        @(cellContext.Item.Type == 1 ? Loc["Job_OneTime"] : Loc["Job_Recurring"])
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="CustomJobsApiClient.JobDto" Title="@Loc["Job_HttpMethod"]">
                <CellTemplate Context="cellContext">
                    <MudChip T="string" Size="Size.Small" Color="@GetHttpMethodColor(cellContext.Item.HttpMethod)">
                        @GetHttpMethodName(cellContext.Item.HttpMethod)
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="CustomJobsApiClient.JobDto" Title="URL">
                <CellTemplate Context="cellContext">
                    <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                        @cellContext.Item.Url
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="CustomJobsApiClient.JobDto" Title="@Loc["Job_Status"]">
                <CellTemplate Context="cellContext">
                    @if (cellContext.Item.IsActive)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">@Loc["Job_Active"]</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.Cancel">@Loc["Job_Inactive"]</MudChip>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="CustomJobsApiClient.JobDto" Title="@Loc["Job_CreatedAt"]">
                <CellTemplate Context="cellContext">
                    <MudText Typo="Typo.body2">@cellContext.Item.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn T="CustomJobsApiClient.JobDto" Title="@Loc["Actions"]">
                <CellTemplate Context="cellContext">
                    <MudTooltip Text="@(cellContext.Item.IsActive ? Loc["Job_Disable"] : Loc["Job_Enable"])">
                        <MudIconButton Icon="@Icons.Material.Filled.PowerSettingsNew" 
                                       Color="@(cellContext.Item.IsActive ? Color.Warning : Color.Success)"
                                       Size="Size.Small"
                                       OnClick="@(() => ToggleJob(cellContext.Item))" />
                    </MudTooltip>
                    <MudTooltip Text="@Loc["Job_Delete"]">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteJob(cellContext.Item))" />
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="CustomJobsApiClient.JobDto" />
        </PagerContent>
        <NoRecordsContent>
            <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.body1" Color="Color.Default">@Loc["Job_NoRecords"]</MudText>
            </MudStack>
        </NoRecordsContent>
    </AppDataGrid>
</MudPaper>

@using AspireAppTemplate.Web
@using MudBlazor
@using Microsoft.Extensions.Localization
@using AspireAppTemplate.Shared.Resources
@inject IStringLocalizer<SharedResource> Loc

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.AddTask" Class="mr-3" Color="Color.Primary" />
            <MudText Typo="Typo.h6">@Loc["Job_Create"]</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudGrid Spacing="2">
                <MudItem xs="12">
                    <MudTextField T="string" Label="@Loc["Job_Name"]" 
                                 @bind-Value="Model.Name" 
                                 Required="true" 
                                 RequiredError="@Loc["RequiredError", Loc["Job_Name"]]"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Placeholder="@Loc["Job_NamePlaceholder"]" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField T="string" Label="@Loc["Job_Description"]" 
                                 @bind-Value="Model.Description" 
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Lines="2"
                                 Placeholder="@Loc["Job_DescriptionPlaceholder"]" />
                </MudItem>
                <MudItem xs="12">
                    <MudSelect T="int" Label="@Loc["Job_TypeLabel"]" 
                              @bind-Value="Model.Type" 
                              Required="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense">
                        <MudSelectItem Value="1">@Loc["Job_OneTime"]</MudSelectItem>
                        <MudSelectItem Value="2">@Loc["Job_Recurring"]</MudSelectItem>
                    </MudSelect>
                </MudItem>

                @if (Model.Type == 1)
                {
                    <MudItem xs="6">
                        <MudDatePicker @bind-Date="_scheduledDate" Label="@Loc["Job_ExecutionDate"]" 
                                      Required="true" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTimePicker @bind-Time="_scheduledTime" Label="@Loc["Job_ExecutionTime"]" 
                                      Required="true" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense" />
                    </MudItem>
                }
                else if (Model.Type == 2)
                {
                    <MudItem xs="12">
                        <MudTextField T="string" Label="@Loc["Job_CronExpression"]" 
                                     @bind-Value="Model.CronExpression" 
                                     Required="true" 
                                     RequiredError="@Loc["RequiredError", Loc["Job_CronExpression"]]"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     HelperText="@Loc["Job_CronHelper"]" />
                    </MudItem>
                }

                <MudItem xs="12">
                    <MudDivider />
                </MudItem>

                <MudItem xs="6">
                    <MudSelect T="int" Label="@Loc["Job_HttpMethod"]" 
                              @bind-Value="Model.HttpMethod" 
                              Required="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense">
                        <MudSelectItem Value="1">GET</MudSelectItem>
                        <MudSelectItem Value="2">POST</MudSelectItem>
                        <MudSelectItem Value="3">PUT</MudSelectItem>
                        <MudSelectItem Value="4">DELETE</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField T="string" Label="@Loc["Job_URL"]" 
                                 @bind-Value="Model.Url" 
                                 Required="true" 
                                 RequiredError="@Loc["RequiredError", Loc["Job_URL"]]"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 HelperText="@Loc["Job_URLHelper"]" />
                </MudItem>

                <MudItem xs="12">
                    <MudButton OnClick="TestUrl" 
                               Color="Color.Info" 
                               Variant="Variant.Text" 
                               Disabled="@(_testing || string.IsNullOrWhiteSpace(Model.Url))" 
                               StartIcon="@Icons.Material.Filled.PlayArrow"
                               Size="Size.Small">
                        @if (_testing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ml-2">@Loc["Job_Testing"]</MudText>
                        }
                        else
                        {
                            <text>@Loc["Job_TestConnection"]</text>
                        }
                    </MudButton>
                </MudItem>

                @if (_testResult != null)
                {
                    <MudItem xs="12">
                        <MudAlert Severity="@(_testResult.IsSuccess ? Severity.Success : Severity.Error)" Dense="true">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body2">
                                    <b>@Loc["Job_TestStatus"]:</b> @(_testResult.IsSuccess ? Loc["Job_TestSuccess"] : Loc["Job_TestFailed"])
                                    @if (_testResult.StatusCode > 0)
                                    {
                                        <text> | <b>HTTP @_testResult.StatusCode</b></text>
                                    }
                                    | <b>@Loc["Job_TestLatency"]:</b> @_testResult.LatencyMs ms
                                </MudText>
                                @if (!string.IsNullOrWhiteSpace(_testResult.ErrorMessage))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Error">
                                        <b>@Loc["Job_TestError"]:</b> @_testResult.ErrorMessage
                                    </MudText>
                                }
                                @if (!string.IsNullOrWhiteSpace(_testResult.ResponseBody))
                                {
                                    <MudExpansionPanels Dense="true">
                                        <MudExpansionPanel Text="@Loc["Job_TestResponse"]">
                                            <MudText Typo="Typo.body2" Style="font-family: monospace; white-space: pre-wrap; font-size: 0.75rem;">@_testResult.ResponseBody</MudText>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }
                            </MudStack>
                        </MudAlert>
                    </MudItem>
                }

                <MudItem xs="12">
                    <MudTextField T="string" Label="@Loc["Job_Headers"]" 
                                 @bind-Value="Model.Headers" 
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Lines="3"
                                 HelperText='@Loc["Job_HeadersHelper"]' />
                </MudItem>

                @if (Model.HttpMethod == 2 || Model.HttpMethod == 3)
                {
                    <MudItem xs="12">
                        <MudTextField T="string" Label="@Loc["Job_Body"]" 
                                     @bind-Value="Model.Body" 
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Lines="5"
                                     HelperText='@Loc["Job_BodyHelper"]' />
                    </MudItem>
                }
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Class="px-6">@Loc["Cancel"]</MudButton>
        <MudButton Color="Color.Primary" 
                   OnClick="Submit" 
                   Variant="Variant.Filled" 
                   Disabled="@(!_isValid)" 
                   Class="px-8 ml-2"
                   DisableElevation="true">@Loc["Create"]</MudButton>
    </DialogActions>
</MudDialog>

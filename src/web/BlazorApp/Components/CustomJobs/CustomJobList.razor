@using System.Net.Http.Json
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudCard>
    <MudCardContent>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateDialog" StartIcon="@Icons.Material.Filled.Add">
            新增任務
        </MudButton>

        <MudTable Items="@_jobs" Class="mt-4" Loading="@_loading" Hover="true" Striped="true">
            <HeaderContent>
                <MudTh>名稱</MudTh>
                <MudTh>類型</MudTh>
                <MudTh>HTTP 方法</MudTh>
                <MudTh>URL</MudTh>
                <MudTh>狀態</MudTh>
                <MudTh>建立時間</MudTh>
                <MudTh>操作</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="名稱">
                    <MudText Typo="Typo.body2">@context.Name</MudText>
                    @if (!string.IsNullOrEmpty(context.Description))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="類型">
                    <MudChip T="string" Size="Size.Small" Color="@(context.Type == 1 ? Color.Info : Color.Success)">
                        @(context.Type == 1 ? "一次性" : "週期性")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="HTTP 方法">
                    <MudChip T="string" Size="Size.Small" Color="@GetHttpMethodColor(context.HttpMethod)">
                        @GetHttpMethodName(context.HttpMethod)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="URL">
                    <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                        @context.Url
                    </MudText>
                </MudTd>
                <MudTd DataLabel="狀態">
                    <CustomJobStatusChip IsActive="@context.IsActive" />
                </MudTd>
                <MudTd DataLabel="建立時間">@context.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</MudTd>
                <MudTd DataLabel="操作">
                    <MudIconButton Icon="@Icons.Material.Filled.PowerSettingsNew" 
                                   Color="@(context.IsActive ? Color.Warning : Color.Success)"
                                   Size="Size.Small" 
                                   OnClick="@(() => ToggleJob(context.Id))"
                                   Title="@(context.IsActive ? "停用" : "啟用")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   Color="Color.Error" 
                                   Size="Size.Small" 
                                   OnClick="@(() => DeleteJob(context.Id))"
                                   Title="刪除" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudCardContent>
</MudCard>

<CustomJobDialog @ref="_dialog" OnJobCreated="LoadJobs" />

@code {
    private List<JobDto> _jobs = new();
    private bool _loading = true;
    private CustomJobDialog? _dialog;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobs();
    }

    private async Task LoadJobs()
    {
        _loading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<GetAllResponse>("/api/custom-jobs");
            _jobs = response?.Jobs ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"載入任務失敗: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OpenCreateDialog()
    {
        _dialog?.Open();
    }

    private async Task ToggleJob(Guid id)
    {
        try
        {
            var response = await Http.PostAsync($"/api/custom-jobs/{id}/toggle", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadJobs();
                Snackbar.Add("任務狀態已更新", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"更新失敗: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteJob(Guid id)
    {
        try
        {
            var response = await Http.DeleteAsync($"/api/custom-jobs/{id}");
            if (response.IsSuccessStatusCode)
            {
                await LoadJobs();
                Snackbar.Add("任務已刪除", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"刪除失敗: {ex.Message}", Severity.Error);
        }
    }

    private Color GetHttpMethodColor(int method) => method switch
    {
        1 => Color.Info,    // GET
        2 => Color.Success, // POST
        3 => Color.Warning, // PUT
        4 => Color.Error,   // DELETE
        _ => Color.Default
    };

    private string GetHttpMethodName(int method) => method switch
    {
        1 => "GET",
        2 => "POST",
        3 => "PUT",
        4 => "DELETE",
        _ => "UNKNOWN"
    };

    private class GetAllResponse
    {
        public List<JobDto> Jobs { get; set; } = new();
    }

    private class JobDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public int Type { get; set; }
        public string? CronExpression { get; set; }
        public DateTime? ScheduledAt { get; set; }
        public int HttpMethod { get; set; }
        public string Url { get; set; } = string.Empty;
        public bool IsActive { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}
